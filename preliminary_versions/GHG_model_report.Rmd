---
title: "Greenhouse gas emissions model"
author: "Cory Whitney and Eike Luedeling"
bibliography:
 - references/packages.bib
 - references/papers.bib
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = F, include = F}
#install and load packages
library(DiagrammeR)
# devtools::install_github("eikeluedeling/decisionSupport")
library(decisionSupport)
library(ggplot2)
library(kableExtra)
library(magrittr)
library(plyr)
library(rmarkdown)
#devtools::install_github("CWWhitney/uncertainty")
library(uncertainty)

#Automatically write R package citation entries to a .bib file
knitr::write_bib(c(.packages(), 
                   'DiagrammeR',
                   'decisionSupport',
                   'MASS'), 'references/packages.bib')
#resolves an issue with the scientific style of numbers,answer from @Paul Hiemstra: https://stackoverflow.com/a/25947542/4061993 
#from the documentation of ?options:
options(scipen=999)
```


## Generating the GHG emissions model

The formulas come from Chapter 10 of the *2006 IPCC Guidelines for National Greenhouse Gas Inventories* [@dong_ipcc_2006] (Volume 4 - Agriculture, Forestry and Other Land Use). The document can be found on [the IPCC website](https://www.ipcc-nggip.iges.or.jp/public/2006gl/pdf/4_Volume4/V4_10_Ch10_Livestock.pdf). The chapter is part of the book *Good Practice Guidance and Uncertainty Management in National Greenhouse Gas Inventories* [@ipcc_good_2021], also on the [the IPCC website](https://www.ipcc-nggip.iges.or.jp/public/gp/english/). Many variables are based on the work done in *Variation in the carbon footprint of milk production on smallholder dairy farms in central Kenya* [@wilkes_variation_2020] and in *Methods and guidance to support MRV of livestock emissions* [@wilkes_methods_2019]. We run the model with the decisionSupport package [@R-decisionSupport].

We load the library and the data. The data contains ranges of possible values for the simulation. Each variable is represented with a confidence interval range and a specification of the distribution shape.

```{r load_data}
### # This project will be stored in relative file paths (i.e. same or lower folders)

 input_table <- "data/livestock_ghg_input_table.csv"

options(knitr.kable.NA = '', encoding = "Windows-1252")
 read.csv(input_table)[,c(1:2,4:6)]   %>%
    kableExtra::kbl(digits = 2)  %>%
    kableExtra::kable_classic_2(full_width = F)

```

The manure management is based on a decision tree. 

## Decision tree for manure management

It is difficult to know with precision how much manure is managed according to each of the management categories. Capturing the corresponding uncertainty is difficult, because estimating each fraction separately is unlikely to add up to 100%. We address this problem with a decision tree.

Each step in the decision tree (each node) represents a share of manure that is managed according to the name of the node. Green arrows indicate 'Yes' and red arrows 'No'. The descriptions for the uses can be found in the IPCC report on manure management chapter 10 [@dong_ipcc_2006].   

```{r graph-mermaid-manure, echo=FALSE, fig.width=4, fig.height=1}
mermaid("
        graph LR
        C(Central collection)-->B(Burned); linkStyle 0 stroke: red, stroke-width:1px
                                B-->P(Pasture); linkStyle 1 stroke: red, stroke-width:1px
        C-->D(Daily spread); linkStyle 2 stroke: green, stroke-width:1px
            D-->S(Sold); linkStyle 3 stroke: red, stroke-width:1px
                S-->L(Liquid storage); linkStyle 4 stroke: red, stroke-width:1px
                    L-->Co(Composted); linkStyle 5 stroke: red, stroke-width:1px
                        Co-->Dl(Dry lot); linkStyle 6 stroke: red, stroke-width:1px
                             Dl-->St(Solid storage); linkStyle 7 stroke: red, stroke-width:1px
                    L-->Bi(Biogas); linkStyle 8 stroke: green, stroke-width:1px
                        Bi-->Ls(Liquid slurry); linkStyle 9 stroke: red, stroke-width:1px
        ")
```

## Making variables for model development

Here we generate a `make_variables` function for testing the model function 'line by line'. We use it to take a single random sample of the provided estimates (this isn't required for running the model later, but it helps when developing the code).

```{r make_variables}

make_variables <- function(est,n=1){ x <- random(rho=est, n=n)
for(i in colnames(x)) assign(i, as.numeric(x[1,i]),envir=.GlobalEnv)}

# run the function on the input_table
make_variables(estimate_read_csv(input_table))
```

## The model

The following is our draft of the emissions model, with explanations of all steps (we can format this better once we agree on the final model).


```{r ghg_emissions_function}
# Generate the GHG emissions function 
source("GHG_emissions_function.R", local = knitr::knit_global())
```

## Running the model

We apply the `decisionSupport` tools for running the Monte Carlo simulation [@R-decisionSupport]. See the vignette guides on *applying the mcSimulation function* [@fernandez_applying_2021] and *simulating the cost effectiveness of controlled burning* [@whitney_simulating_2017] for examples.

```{r monte_carlo_simulation}
GHG_simulation <- mcSimulation(
  estimate = estimate_read_csv("data/livestock_ghg_input_table.csv"),
  model_function = ghg_emissions,
  numberOfModelRuns = 1e4, # 10,000 runs
  functionSyntax = "plainNames"
)
```

Here we plot the distributions of the various outputs from the model. 

```{r plot_distributions, fig.width=10, fig.height=10, include = F}
# add , include = F to keep this distribution figure building step out of the RMD
# enteric_CH4=enteric_CH4,
enteric_CH4_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "enteric_CH4",
                   method = "boxplot_density",
                   old_names = "enteric_CH4",
                   new_names = "Total Methane Emissions from Livestock by Enteric Fermentation") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# milk_yield=sum(total_milk),
milk_yield_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "milk_yield",
                   method = "boxplot_density",
                   old_names = "milk_yield",
                   new_names = "Total Milk Yield") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# enteric_CH4_CO2eq=sum(enteric_CH4_CO2eq),
enteric_CH4_CO2eq_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "enteric_CH4_CO2eq",
                   method = "boxplot_density",
                   old_names = "enteric_CH4_CO2eq",
                   new_names = "Carbon Dioxide Equivalent Enteric Methane Emissions from Livestock") + 
  theme(axis.title.x=element_blank())

# mm_CH4_CO2eq=sum(mm_CH4_CO2eq),
mm_CH4_CO2eq_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "mm_CH4_CO2eq",
                   method = "boxplot_density",
                   old_names = "mm_CH4_CO2eq",
                   new_names = "Carbon Dioxide Equivalent Methane Emissions from Livestock Manure") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# mm_N2O_CO2eq=sum(mm_N2O_CO2eq),
mm_N2O_CO2eq_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "mm_N2O_CO2eq",
                   method = "boxplot_density",
                   old_names = "mm_N2O_CO2eq",
                   new_names = "Carbon Dioxide Equivalent Nitrous Oxide Emissions from Livestock Manure") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# feed_CO2=feed_CO2,
feed_CO2_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "feed_CO2",
                   method = "boxplot_density",
                   old_names = "feed_CO2",
                   new_names = "Carbon Dioxide Emissions from Livestock Feed Production and Transport") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# on_farm=sum(on_farm)
on_farm_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "on_farm",
                   method = "boxplot_density",
                   old_names = "on_farm",
                   new_names = "Total Carbon Dioxide Equivalent Emissions from Livestock") + 
  theme(axis.title.y=element_blank())

library(patchwork)
# remove the axis marks from the two lefthand-most plots and the x-axis title from the left and right plots

# plot with patchwork
layout <- "
           AAABBB
           CCCDDD
           EEEFFF
           GGGGGG
          "

enteric_CH4_dist_plot + milk_yield_dist_plot + 
  enteric_CH4_CO2eq_dist_plot + mm_CH4_CO2eq_dist_plot + 
  mm_N2O_CO2eq_dist_plot + feed_CO2_dist_plot + 
  on_farm_dist_plot + 
plot_layout(guides = "collect", design = layout) 
```

## Model sensitivity

#### Perform a Partial Least Squares Regression (PLSR) of Monte Carlo simulation results

Below we apply a post-hoc analysis to the `mcSimulation()` outputs with the `plsr.mcSimulation()` function in the `decisionSupport` package. We use the function to determine the Variable Importance in the Projection (VIP) score and coefficients of a Projection to Latent Structures (PLS) regression model. This function uses the outputs of the `mcSimulation()` selecting all the input variables from the `GHG_simulation` decision analysis function in the parameter `object` and then runs a PLS regression with an outcome variable defined in the parameter `resultName`. We use the code `names(GHG_simulation$y)[7]` to select the outcome variable `r names(GHG_simulation$y)[7]`, which is an element of the list `y` in our `GHG_simulation` outputs. 

```{r}
pls_result <- plsr.mcSimulation(object = GHG_simulation,
                  resultName = names(GHG_simulation$y)[7], 
                  ncomp = 1)
```

We run the `plot_pls()` on the results from `plsr.mcSimulation()` with a number of standard settings. The length of the bars is equal to VIP with a vertical line at '1' on the x-axis indicating a standard cut-off for VIP used for variable selection [@Whitney2017]. The overall plot only shows those variables with a VIP > 0.8, which is the common threshold for variable selection [@Lanzanova2019, @Luedeling2016]. The colors of the bars represent the positive or negative coefficient of the given input variable with the output variable.

Here we import the input table again (the same table we used for the Monte Carlo model) to replace the labels for the variables on the y-axis. The input table includes a 'label' and 'variable' column. The standard labels (from the 'variable' column) are usually computer readable and not very nice for a plot. The `plot_pls()` function uses the text in the 'label' column as replacement for the default text in the 'variable' column.  

```{r}
input_table <- read.csv("data/livestock_ghg_input_table.csv")

plot_pls(pls_result, 
         input_table = input_table, 
         threshold = 0)
```


# Uncertainty

Here we apply a collection of functions for use in assessing uncertainty in the relationship between GHG emissions and milk yields in livestock production. We use functions from the `uncertainty` package. Install the package using `devtools::install_github("CWWhitney/uncertainty")`. 

We apply the uncertainty functions on the `milk_yield` and `on_farm` variables. These come from the model results (`r nrow(GHG_simulation$y)`) of the `GHG_simulation` model results to the `in_var` (x) and an outcome variable `out_var` (y). In the model we defined `on_farm` as the sum of Carbon Dioxide Equivalent Enteric Methane Emissions from Livestock (`enteric_CH4_CO2eq`), Carbon Dioxide Equivalent Methane Emissions from Livestock Manure (`mm_CH4_CO2eq`), Carbon Dioxide Equivalent Nitrous Oxide Emissions from Livestock Manure (`mm_N2O_CO2eq`) and Carbon Dioxide Emissions from Livestock Feed Production and Transport (`feed_CO2`).

```{r name_in_out_vars}
in_var  <- GHG_simulation$y$milk_yield # "Total Milk Yield"
out_var <- GHG_simulation$y$on_farm # "Total emissions"
```

## Milk_yield (x-axis) effect on on-farm GHG emissions (y-axis)

Here we use the `varscatter()` function to create a scatter plot of milk yields `in_var` (x) and GHG emissions `out_var` (y) with associated and estimated densities with loess smooth linear fits density curves. We created the plot with the `scatter.hist()` function in the `plyr()` package [@R-plyr] in R [@R-base]. The result is a scatter plot with associated and estimated densities (using a loess smooth) given by the red dot (mean) and red ellipses (1 and 2 sigma from mean). The red line going across the plot shows the linear fit. Histograms are shown with smooth lines (loess smooth linear fits) density curves. The numeric value in the upper right gives the Spearman correlation coefficient between the influencing variable and the outcome variable.

```{r uncertainty_package}
uncertainty::varscatter(in_var = in_var,
                        out_var = out_var,
                        xlab = "Total Milk Yield",
                        ylab = "Total emissions")
```

To verify the finding we use the `varkernel()` function for another type of graphical representation of the same relationship. We use the `varkernel()` function to perform a two-dimensional kernel density estimation for the expected value of GHG emissions and milk yield. The core of the process involves kernel density estimation. This is a nonparametric technique for estimating probability density functions (similar to histogram density estimation but with more dimensions). We apply this with the `kde2d()` function in the `MASS()` package [@R-MASS]. The function produces a matrix of the estimated density (z) of the expected value of the GHG emissions and milk yield. It looks slightly different than the scatter plot estimates above because the density function restricts the shape of the kernel to a normal distribution (a bivariate normal kernel).

```{r varkernel}
uncertainty::varkernel(in_var = in_var, 
                       out_var = out_var,
                        xlab = "Total Milk Yield",
                        ylab = "Total emissions")
```

The result of the `varkernel()` function shows a density surface plot of GHG emissions `in_var` (x) and milk yield `out_var` (y). In these `varkernel()` the density (z) over the entire plot integrates to one, and therefore represents the relative probability of an observation (the GHG emissions `out_var` along the y-axis) given a specific value for milk yield `in_var` (along the x-axis). The legend shows the value for the estimated density (z). The plot is made with the `filled.contour()` function of the `graphics()` package [@R-base]. 

## Probability of GHG emissions for a given range of milk yield

We use the `varkernelslicerange()` function to show the total emissions given a specified milk yield (influencing variable `in_var` value) interval. Here we choose a very wide distribution (the whole range of milk yields from the Monte Carlo simulation). Here we set the maximum expected value for milk yield `in_var` to the maximum (`r round(max(in_var), digits = 0)`) and the minimum expected value (`r round(min(in_var), digits = 0)`) from our simulation. We can also choose another range by supplying milk yield values to `max_in_var` and `min_in_var`. 

```{r varkernelslicerange}
uncertainty::varkernelslicerange(in_var = in_var, 
                                 out_var = out_var, 
                                 min_in_var = round(min(in_var)),
                                 max_in_var = round(max(in_var)), 
                                 xlab_vars = "Total emissions given milk yield range")
```

`varkernelslicerange()` plots the probabilities (shown along the y-axis) for the expected value of the outcome variable `out_var` (shown along the x-axis). As with `varkernelslice()` the probability values shown are relative, not absolute measures. They are the result of cuts through the density kernel `varkernel()`, which integrates to 1. 

## Influencing variable intervals

For a more specific estimate we can choose from those optimized interquartile ranges to select a range to slice from the density kernel `varkernel()`. We do that here using the `varviolin()` function to determine meaningful milk yield variable intervals and how they interact with the outcome variable GHG emissions. We do this by calculating an 'optimal' interval width using the interquartile range `IQR()` function in the `stats()` package. 

```{r varviolin, fig.width=17, fig.height=7}
uncertainty::varviolin(in_var = in_var, 
                       out_var = out_var, 
                       legend.position = "left",
                        xlab = "Total Milk Yield",
                        ylab = "Total emissions")
```

The result of the `varviolin()` function shows violin plots of milk yield `in_var` values (x) and our outcome variable GHG emissions `out_var` (y) values. The plot was made with `ggplot2()` [@R-ggplot2]. These offer a possible selection of milk yields and show the resulting expected GHG emissions.

This document was generated using R Markdown [@R-rmarkdown].

# References