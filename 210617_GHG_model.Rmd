---
title: "Greenhouse gas emissions model"
author: "Cory and Eike"
bibliography:
 - references/packages.bib
 - references/papers.bib
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = F, include = F}
#install and load packages
library(decisionSupport)
library(ggplot2)
library(plyr)
library(rmarkdown)
# devtools::install_github("CWWhitney/uncertainty")
library(uncertainty)

#Automatically write R package citation entries to a .bib file
knitr::write_bib(c(.packages(), 
                   'decisionSupport'), 'references/packages.bib')

```


## Generating the GHG emissions model

We're looking at the equation put together by Joshua Wafula to check if this can easily be used by decisionSupport [@R-decisionSupport], and to possibly optimize the model.

The formulas come from Chapter 10 of the *2006 IPCC Guidelines for National Greenhouse Gas Inventories* [@dong_ipcc_2006] (Volume 4 - Agriculture, Forestry and Other Land Use). The document can be found on [the IPCC website](https://www.ipcc-nggip.iges.or.jp/public/2006gl/pdf/4_Volume4/V4_10_Ch10_Livestock.pdf). The chapter is part of the book *Good Practice Guidance and Uncertainty Management in National Greenhouse Gas Inventories* [@ipcc_good_2021] , also on the [the IPCC website](https://www.ipcc-nggip.iges.or.jp/public/gp/english/). Many variables are based on the work done in *Variation in the carbon footprint of milk production on smallholder dairy farms in central Kenya* [@wilkes_variation_2020] and in *Methods and guidance to support MRV of livestock emissions* [@wilkes_methods_2019].

**Here are our changes and additions to the original model:**

```{r load_data}

library(decisionSupport)
###CW Note ####
# #### remove all the 'C:/Users/jwafula/Dropbox/UNIQUE_CCAFS/analysis/data/' folder locations throughout - 
#### these are not useful with RMD and RStudio / Git integrations
###CW Note ####
### # This project will be stored in relative file paths (i.e. same or lower folders)
input_table <- "data/livestock_ghg_input_table.csv"
```

Here we generate a `make_variables` function for testing the model function 'line by line'. We use it to take a single random sample of the provided estimates.

```{r make_variables}
### Reasonable ranges still missing for many variables
make_variables <- function(est,n=1){ x <- random(rho=est, n=n)
for(i in colnames(x)) assign(i, as.numeric(x[1,i]),envir=.GlobalEnv)}

# run the function on the input_table
make_variables(estimate_read_csv(input_table))
```

```{r ghg_emissions_function}
# Generate the GHG emissions function 
ghg_emissions<-function(x, varnames){

# Enteric fermentation emissions ($CH_4$)

# The main source of all this is Chapter 10 of the *2006 IPCC Guidelines for National Greenhouse Gas Inventories* [@dong_ipcc_2006] (Volume 4 - Agriculture, Forestry and Other Land Use). The document can be found on [the IPCC website](https://www.ipcc-nggip.iges.or.jp/public/2006gl/pdf/4_Volume4/V4_10_Ch10_Livestock.pdf).

# We start with the net energy for maintenance (NE_m; in MJ/day)
# This includes a maintenance coefficient, for which different values are recommended depending on animal type

# We're not sure what the animal types stand for, but we inferred some information from the numbers in the sample dataset. We further looked for guidance in the "Good Practice Guidance and Uncertainty Management in National Greenhouse Gas Inventories" (https://www.ipcc-nggip.iges.or.jp/public/gp/bgp/4_1_CH4_Enteric_Fermentation.pdf)
  
# animal type 1 - 'intact' grown-up males >=36 months
# animal type 2 - castrated grown-up males >=36 months
# animal type 3 - males 12-36 months
# animal type 4 - lactating cows
# animal type 5 - lactating cows
# animal type 6 - lactating cows
# animal type 7 - weaned young females <= 12 months
# animal type 8 - weaned young males <= 12 months
# animal type 9 - females 12-36 months
# animal type 10 - pre-weaned female calves (<12 months)
# animal type 11 - pre-weaned male calves (<12 months)
# animal type 12 - first-time pregnant cows
  
# animal types 4, 5 and 6 are all lactating cows - important to note here that the original data table appears to have worked with the actual number of months that cows were pregnant. This resulted in a weighted mean of the various maintenance coefficients. We're not sure where we could get such data.

  mm_N2O_CO2eq<-c()
  mm_CH4_CO2eq<-c()
  enteric_CH4_CO2eq<-c()
  total_milk<-c()
  
for (animal_type in 1:12)
{
# define C and Cfi based on sex (Page 10.17, below Equation 10.6)
if(animal_type %in% c(1,3,8,11)) growth_coefficient_C<-C_intact_males # males (1.2)
if(animal_type %in% c(2)) growth_coefficient_C<-C_castrates # castrates (1.0)
if(animal_type %in% c(4,5,6,7,9,10,12)) growth_coefficient_C<-C_females # females (0.8)

if(animal_type %in% c(4,5,6)) Cfi<-maintenance_coefficient_Cfi_lact_cow # lactating cows (0.386)
if(animal_type %in% c(1)) Cfi<-maintenance_coefficient_Cfi_bulls # bulls (0.37)
if(animal_type %in% c(2,3,7,8,9,10,11,12)) Cfi<-maintenance_coefficient_Cfi_other # others (0.322)

# define mature body weight (assuming this needs to be disaggregated by sex, for Eqation 10.6)
if(animal_type %in% c(1,2,3,8,11)) mature_weight_MW<-mature_weight_MW_male
if(animal_type %in% c(4,5,6,7,9,10,12)) mature_weight_MW<-mature_weight_MW_female

# define milk yield
if(animal_type %in% c(1,2,3,7,8,9,10,11,12)) milk_yield<-0
if(animal_type %in% c(4,5,6)) milk_yield<-eval(parse(text=paste0("milk_yield_",animal_type)))

#define pregnancy coefficient (full Cp for first-time pregnant, lower for later in most cases)
if(animal_type==12) Cp<-Cp_0
if(animal_type==4) Cp<-Cp_0*Cp_rate_4
if(animal_type==5) Cp<-Cp_0*Cp_rate_5
if(animal_type==6) Cp<-Cp_0*Cp_rate_6
if(animal_type %in% c(1,2,3,7,8,9,10,11)) Cp<-0

N_animal_type<-eval(parse(text=paste0("N_animal_type_",animal_type)))

# define activity coefficient Ca (Table 10.5)
# Stall 0.00 - Animals are confined to a small area (i.e., tethered, pen, barn) with the result that they expend very little or no energy to acquire feed.
# Pasture 0.17 - Animals are confined in areas with sufficient forage requiring modest energy expense to acquire feed.
# Grazing large areas 0.36 - Animals graze in open range land or hilly terrain and expend significant energy to acquire feed.

# We don't quite understand how Ca was assigned in the original data table. There are many 0s for 'System 1' (Stall?), but also lots of values between 0 and 0.17 or 0.36. We can only imagine that these are weighted averages or reflect additional information about the feeding system, but this information doesn't seem to be given in the table. For now, we're restricting these Ca values to only those that are given as 'pure' categories in the IPCC guidelines (Table 10.5).

if(feeding_system==1) C_activity<-Ca_stall # Stall (0.0)
if(feeding_system==2) C_activity<-Ca_pasture # Stall (0.17)
if(feeding_system==3) C_activity<-Ca_large_grazing # Stall (0.36)
  
# Mean live weight (kg) of animals surely varies by animal type, so we need separate estimates for them
live_weight_LW<-eval(parse(text=paste0("live_weight_LW_",animal_type)))

# Mean weight gain of animal type (kg/day)
weight_gain_WG<-eval(parse(text=paste0("weight_gain_WG_",animal_type)))

# Calculate the Net Energy for Maintenance (NE_m) (MJ/day) (Equation 10.3)

NE_m<-Cfi*(live_weight_LW^0.75)

# Calculate the Net Energy for Activity (NE_activity) (MJ/day) (Equation 10.4)

NE_activity<-C_activity*NE_m

#Net energy for growth (NE_growth) (MJ/day) (Equation 10.6)

NE_growth<-22.02*
  ((live_weight_LW/(growth_coefficient_C*mature_weight_MW))^0.75)*
  (weight_gain_WG^1.097)

#Net energy for lactation

NE_lactation<-milk_yield*(1.47+0.40*milk_fat)

#milk_yield (kg milk per day)
#milk_fat (percent)

#Draft animal services are not accounted for
#NE_work <- 0.1 * NE_m * hours_per_day

#Energy need during pregnancy (Equation 10.13)
NE_pregnancy<-Cp*NE_m

# the Cp coefficient given in Equation 10.13 is 0.1, but in the sample this is only applied for animal type 12 (first-time pregnant). For all other lactating cows, this is reduced - not clear how this was done.

# Ratio of net energy available in a diet for maintenance to digestible energy consumed (Equation 10.14)
REM<-1.123-(4.092/1000*DE_perc)+(1.126/100000*DE_perc^2)-(25.4/DE_perc)

# Ratio of net energy available for growth in a diet to digestible energy consumed (Equation 10.15)
REG<-1.164-(5.160/1000*DE_perc)+(1.308/100000*DE_perc^2)-(37.4/DE_perc)

# Gross Energy (GE) MJ/day
NE_work<-0 # work animals aren't covered here, so we set this to zero
GE<-(((NE_m+NE_activity+NE_lactation+NE_work+NE_pregnancy)/REM)+(NE_growth/REG))/(DE_perc/100)

# CH4 emission factors for enteric fermentation from a livestock category (Equation 10.21)

enteric_CH4<-(GE*Y_m*365)/55.65 # kg CH4 per animal per year


# Compute the CO2-equivalent of methane emissions for enteric methane
#This converts methane emissions to their Global Warming Potential (CO2-equivalent of CH4 is 25)
enteric_CH4_CO2eq[animal_type]<-N_animal_type*enteric_CH4*25

# Manure management methane ($CH_4$) and nitrous oxide ($N_2O$)
# daily volatile solid excreted (Equation 10.24)

volsol<-(GE*
           (1-(DE_perc/100))+
           (urinary_energy*GE))*
             ((1-ash_content)/18.45) 

# The maximum methane emission from manure (Bo) depends on the animal type. In the input table, we
# treat these as constants for each animal type. The following line assigns the corresponding Bo value
##### EL CW Note #### 
##### # to the Bo variable. In the dataset we're using for Kenya, only two values for Bo are given: 0.17 for
# animal types 4-6 and 0.135 for animal types 1-3 and 7-12.

Bo<-eval(parse(text=paste0("Bo_animaltype_",animal_type)))

# decisions on manure management
# the management options we're considering here are the ones from the Excel table. The IPCC guidelines
# list more and partly different ones.

# We're deciding on manure management according to a decision tree (Cory will build a figure):

# question 1: how much of the manure is centrally collected? share_centrally
# question 2: of manure that's not centrally collected, how much is burned? share_central_burn
mms_burn<-(1-share_centrally)*share_central_burn
mms_pasture<-(1-share_centrally)*(1-share_central_burn)

# question 3: of centrally collected manure, how much is spread daily on cropland or pasture? share_spread
mms_spread<-share_centrally*share_spread
not_spread<-share_centrally*(1-share_spread)
# question 4: how much of the manure that's not spread is sold? share_sold
mms_sold<-not_spread*share_sold
not_sold<-not_spread*(1-share_sold)
# question 5: how much of the stored manure that's not sold is stored in liquid form? share_liquid
liquid<-not_sold*share_liquid
solid<-not_sold*(1-share_liquid)
# question 6: how much of the liquid manure is converted to biogas? share_biogas
mms_biogas<-liquid*share_biogas
mms_liquid_slurry<-liquid*(1-share_biogas)
# question 7: how much of the solid manure is composted? share_compost
mms_composted<-solid*share_compost
remain_solid<-solid*(1-share_compost)
# question 8: how much of the solid manure is stored in dry lots? share_drylot
mms_drylot<-remain_solid*share_drylot
mms_solidstore<-remain_solid*(1-share_drylot)

# CH4 emission factor from manure management (Equation 10.23)
mm_ch4<-(volsol*365)*
        (Bo*0.67*
           ((mms_pasture*MCFpasture)+
            (mms_spread*MCFspread)+
            (mms_drylot*MCFdrylot)+
            (mms_solidstore*MCFsolidstore)+
            (mms_composted*MCFcomposted)+
            (mms_liquid_slurry*MCFliquid)+
            (mms_biogas*MCFbiogas)+
            (mms_burn*MCFburn)+
              # the original code was lacking the 'sold' fraction - we added this for completeness
            (mms_sold*MCFsold)))

# Estimate CO2eq for manure methane
mm_CH4_CO2eq[animal_type]<-N_animal_type*mm_ch4*25

# Calculate Nitrous oxide emissions from manure and urine on pasture

# estimate N intake (kg/animal/day) (Equation 10.32)
N_intake<-(GE/18.45)*((perc_crude_protein_diet/100)/6.25)

# estimate N retention (kg/animal/day) (Equation 10.33)
N_retention<-((milk_yield*(1.9+0.4*milk_fat)/100)/6.38)+
  ((weight_gain_WG*(268-(7.03*NE_growth/weight_gain_WG)))/(1000*6.25))

# estimate N excretion (kg N/animal/yr) (Equation 10.31)
N_excretion<-N_intake*(1-N_retention)*365

# Direct nitrous oxide emissions (kg N2O/animal/yr) (Eq 10.25 from IPCC guidelines)
mm_direct_n2o<-N_excretion*((mms_pasture*mndec_pasture)+
                           (mms_spread*mndec_spread)+
                           (mms_drylot*mndec_drylot)+
                           (mms_solidstore*mndec_solidstore)+
                           (mms_composted*mndec_composted)+
                           (mms_liquid_slurry*mndec_liquid)+
                           (mms_biogas*mndec_biogas)+
                           (mms_burn*mndec_burn)+
                           (mms_sold*mndec_sold))*(44/28)

# N losses from volatilization (kg N/animal/yr) (Eq 10.26 from IPCC guidelines)
mm_vol_n<-N_excretion*((mms_pasture*mnvc_pasture)+
                           (mms_spread*mnvc_spread)+
                           (mms_drylot*mnvc_drylot)+
                           (mms_solidstore*mnvc_solidstore)+
                           (mms_composted*mnvc_composted)+
                           (mms_liquid_slurry*mnvc_liquid)+
                           (mms_biogas*mnvc_biogas)+
                           (mms_burn*mnvc_burn)+
                           (mms_sold*mnvc_sold))

# indirect N2O emissions due to volatilization of N from manure management (kg N2O/animal/year) (Equation 10.27)
mm_vol_n2o<-mm_vol_n*EF4*(44/28)

# Nitrous oxide (N2O) from leaching (kg N/animal/year) (equation 10.28)
mm_leach_n<-N_excretion*((mms_pasture*frac_leach_pasture)+
                           (mms_spread*frac_leach_spread)+
                           (mms_drylot*frac_leach_drylot)+
                           (mms_solidstore*frac_leach_solidstore)+
                           (mms_composted*frac_leach_composted)+
                           (mms_liquid_slurry*frac_leach_liquid)+
                           (mms_biogas*frac_leach_biogas)+
                           (mms_burn*frac_leach_burn)+
                           (mms_sold*frac_leach_sold))

# indirect N2O emissions due to leaching of N from manure management (kg N2O/animal/year) (Equation 10.29)
mm_leach_n2o<-mm_leach_n*EF5*(44/28)

# comment: this is probably wrong, since leached nitrogen doesn't emit (much) nitrous oxide
#mm_leach_n2o<-n_excretion*((mms_pasture*0.3)+(mms_spread*0.3)+(mms_drylot*0.3)+(mms_solidstore*0.3)+
#              (mms_composted*0.3)+(mms_liquid*0.3)+(mms_biogas*0)+(mms_burn*0))*0.0075*(44/28)

# Estimate CO2eq for manure nitrous
mm_N2O_CO2eq[animal_type]<-N_animal_type*(mm_direct_n2o+mm_vol_n2o+mm_leach_n2o)*298 # (298 is the CO2-equivalent of N2O)

total_milk[animal_type]<-N_animal_type*milk_yield*365

}

  


# Emissions from feed production and transport. 
# comment: the numbers in the table seem spuriously precise.
feed_CO2<-feed_prod_CO2*feed_trans_CO2

# Total emissions
on_farm<-enteric_CH4_CO2eq+mm_CH4_CO2eq+mm_N2O_CO2eq+feed_CO2

#CW Note ####
# Not clear what this part does (through to the ggplot)

# Relationship between greenhouse gas intensity and milk yields. 
# Fat adjusts
#ann_adj <-kg_FPCM_year*365 
#df <- data.frame(
#  GHGi = on_farm/ann_adj, 
#  FPCM = ann_adj)

# ### ##### CW Note
# Removing this plot
# plot

#library(ggplot2)
#ggplot(df, aes(x = FPCM, y = GHGi)) +geom_point() + ylim(0,50) 

return(list(enteric_CH4=enteric_CH4,
            #CW NOTE ####
            # ####working backwards from 'enteric_CO2' I see that 
            # #### this is the product of something twice multiplied by 365
            # ####### 
            milk_yield=sum(total_milk),
            enteric_CH4_CO2eq=sum(enteric_CH4_CO2eq),
            mm_CH4_CO2eq=sum(mm_CH4_CO2eq),
            mm_N2O_CO2eq=sum(mm_N2O_CO2eq),
            feed_CO2=feed_CO2,
            on_farm=sum(on_farm)))
}

```

Apply the `decisionSupport` tools for running the Monte Carlo [@R-decisionSupport]. See the vignette guides on *applying the mcSimulation function* [@fernandez_applying_2021] and *simulating the cost effectiveness of controlled burning* [@whitney_simulating_2017] for examples.

```{r monte_carlo_simulation}

GHG_simulation <- mcSimulation(
  estimate = estimate_read_csv("data/livestock_ghg_input_table.csv"),
  model_function = ghg_emissions,
  numberOfModelRuns = 1e3, #1000 for now
  functionSyntax = "plainNames"
)

```

```{r plot_distributions}

plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "enteric_CH4_CO2eq",
                   method = "boxplot_density",
                   old_names = "enteric_CH4_CO2eq",
                   new_names = "Methane Emissions from Enteric Fermentation")

```

# uncertainty

Here we apply a collection of functions for use in assessing uncertainty from the `uncertainty` package. Install using `devtools::install_github("CWWhitney/uncertainty")`. 

Here we use the `varscatter()` function to create a scatter plot of an influence variable of interest `in_var` (x) and an outcome variable `out_var` (y) with associated and estimated densities with loess smooth linear fits density curves. Plot made with the scatter.hist() function in the plyr() package [@R-plyr] in R [@R-base]. 

Check the `milk_yield` effect on `enteric_CH4`.

```{r uncertainty_package}
uncertainty::varscatter(in_var = GHG_simulation$y$milk_yield,
                        out_var = GHG_simulation$y$enteric_CH4_CO2eq)
```

Use `varkernel()` for another type of graphical representation of the same relationship. `varkernel()` performs a two-dimensional kernel density estimation for the expected value of the outcome variable `out_var` and the influence variable of interest `in_var` using the `kde2d()` function in the `MASS()` package (Venables and Ripley 2002). The function produces a matrix of the estimated density (z) of the expected value of the outcome variable `out_var` (y) and the influence variable of interest `in_var` (x). It looks slightly different than the scatter plot estimates above because the density function restricts the shape of the kernel to a bivariate normal kernel.

Check the effect of `in_var` `milk_yield` on the `out_var` `enteric_CH4_CO2eq`.

```{r name_in_out_vars}
in_var  <- GHG_simulation$y$milk_yield
out_var <- GHG_simulation$y$enteric_CH4_CO2eq
```

```{r varkernel}
uncertainty::varkernel(in_var = in_var, out_var = out_var)
```

`varkernel()` shows a density surface plot of a given influence variable of interest `in_var` (x) and the outcome variable `out_var` (y). The legend shows the value for the estimated density (z). The plot is made with the `filled.contour()` function of the `graphics()` package.

In `varkernel()` the density (z) over the entire plot integrates to one, and therefore represents the relative probability of an observation (the outcome variable `out_var` along y-axis) given a specific value for a given influence variable of interest `in_var` (along x-axis). 

## Estimated outcome variable `out_var` given the expected variable

`varkernelslice()` calculates the estimated outcome variable `out_var` given the expected value of the influence variable of interest `in_var`, based on a slice of 'z' from the Kernel density calculated with `varkernel()`. The `expectedvariable` parameter is set to 30.

```{r varkernelslice}
uncertainty::varkernelslice(in_var = in_var, out_var = out_var, expectedin_var = 30)
```

`varkernelslice()` plots the probabilities (shown along the y-axis) for the expected value of the outcome variable `out_var` (shown along the x-axis). Since this is a cut through the density kernel `varkernel()`, which integrates to 1, the probability values are relative, not absolute measures.

## Influencing variable intervals

`varviolin()` determines different possible influencing variable intervals `in_var` by calculating the optimal interval width for the given variable values. This is done using the `IQR()` function in the `stats()` package, after the Freedman-Diaconis rule (IQR = interquartile range).

$Os = 2 * IQRs / (obs_IQRs)^{(1/3)}$

Where $Os$ is The optimal interval width for our sample, $IQRs$ is the interquartile range for our sample and $obs_IQRs$ is the total number of observations for the interquartile range for our sample.

```{r varviolin}
uncertainty::varviolin(in_var = in_var, out_var = out_var)
```

`varviolin()` shows violin plots of influencing variable `in_var` values (x) and outcome variable `out_var` (y) values, with six different intervals of influencing variable `in_var` values. Plot made with `ggplot2()` [@R-ggplot2].

## Probability of outcome variable given variable

`varkernelslicerange()` shows the influencing variable `in_var` value intervals, optimized interquartile ranges shown in `varviolin()` can be used to select a range to slice from the density kernel `varkernel()` as was done for a single variable value in `varkernelslice()`. Here we set the maximum expected value for `in_var` to 4 and the minimum expected value to 1.

```{r varkernelslicerange}
uncertainty::varkernelslicerange(in_var = in_var, out_var = out_var, 
                                 min_in_var = round(min(in_var)+(max(in_var)-min(in_var))/4),
                                 max_in_var = round(min(in_var)+(max(in_var)-min(in_var))/4*3))
```

`varkernelslicerange()` plots the probabilities (shown along the y-axis) for the expected value of the outcome variable `out_var` (shown along the x-axis). As with `varkernelslice()` the probability values shown are relative, not absolute measures. They are the result of cuts through the density kernel `varkernel()`, which integrates to 1. 

This document was generated using R Markdown [@R-rmarkdown].

# References