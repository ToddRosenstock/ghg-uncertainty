---
title: "Greenhouse gas emissions model"
author: "Cory Whitney and Eike Luedeling"
bibliography:
 - references/packages.bib
 - references/papers.bib
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = F, include = F}
#install and load packages
library(DiagrammeR)
library(decisionSupport)
library(ggplot2)
library(plyr)
library(rmarkdown)
# devtools::install_github("CWWhitney/uncertainty")
library(uncertainty)

#Automatically write R package citation entries to a .bib file
knitr::write_bib(c(.packages(), 
                   'DiagrammeR',
                   'decisionSupport',
                   'MASS'), 'references/packages.bib')
#resolves an issue with the scientific style of numbers,answer from @Paul Hiemstra: https://stackoverflow.com/a/25947542/4061993 
#from the documentation of ?options:
options(scipen=999)
```


## Generating the GHG emissions model

The formulas come from Chapter 10 of the *2006 IPCC Guidelines for National Greenhouse Gas Inventories* [@dong_ipcc_2006] (Volume 4 - Agriculture, Forestry and Other Land Use). The document can be found on [the IPCC website](https://www.ipcc-nggip.iges.or.jp/public/2006gl/pdf/4_Volume4/V4_10_Ch10_Livestock.pdf). The chapter is part of the book *Good Practice Guidance and Uncertainty Management in National Greenhouse Gas Inventories* [@ipcc_good_2021], also on the [the IPCC website](https://www.ipcc-nggip.iges.or.jp/public/gp/english/). Many variables are based on the work done in *Variation in the carbon footprint of milk production on smallholder dairy farms in central Kenya* [@wilkes_variation_2020] and in *Methods and guidance to support MRV of livestock emissions* [@wilkes_methods_2019]. We run the model with the decisionSupport package [@R-decisionSupport].

We load the library and the data. The data contains ranges of possible values for the simulation. Each variable is represented with a confidence interval range and a specification of the distribution shape.

```{r load_data}
library(DiagrammeR)
library(decisionSupport)
library(plyr)
library(magrittr)
library(kableExtra)
### # This project will be stored in relative file paths (i.e. same or lower folders)

 input_table <- "data/livestock_ghg_input_table.csv"

options(knitr.kable.NA = '', encoding = "Windows-1252")
 read.csv(input_table)[,c(1:2,4:6)]   %>%
    kableExtra::kbl(digits = 2)  %>%
    kableExtra::kable_classic_2(full_width = F)

```

The manure management is based on a decision tree. 

## Decision tree for manure management

It is difficult to know with precision how much manure is managed according to each of the management categories. Capturing the corresponding uncertainty is difficult, because estimating each fraction separately is unlikely to add up to 100%. We address this problem with a decision tree.

Each step in the decision tree (each node) represents a share of manure that is managed according to the name of the node. Green arrows indicate 'Yes' and red arrows 'No'. The descriptions for the uses can be found in the IPCC report on manure management chapter 10 [@dong_ipcc_2006].   

```{r graph-mermaid-manure, echo=FALSE, fig.width=10, fig.height=1}
mermaid("
        graph LR
        C(Central collection)-->B(Burned); linkStyle 0 stroke: red, stroke-width:1px
                                B-->P(Pasture); linkStyle 1 stroke: red, stroke-width:1px
        C-->D(Daily spread); linkStyle 2 stroke: green, stroke-width:1px
            D-->S(Sold); linkStyle 3 stroke: red, stroke-width:1px
                S-->L(Liquid storage); linkStyle 4 stroke: red, stroke-width:1px
                    L-->Co(Composted); linkStyle 5 stroke: red, stroke-width:1px
                        Co-->Dl(Dry lot); linkStyle 6 stroke: red, stroke-width:1px
                             Dl-->St(Solid storage); linkStyle 7 stroke: red, stroke-width:1px
                    L-->Bi(Biogas); linkStyle 8 stroke: green, stroke-width:1px
                        Bi-->Ls(Liquid slurry); linkStyle 9 stroke: red, stroke-width:1px
        ")
```

## Making variables for model development

Here we generate a `make_variables` function for testing the model function 'line by line'. We use it to take a single random sample of the provided estimates (this isn't required for running the model later, but it helps when developing the code).

```{r make_variables}

make_variables <- function(est,n=1){ x <- random(rho=est, n=n)
for(i in colnames(x)) assign(i, as.numeric(x[1,i]),envir=.GlobalEnv)}

# run the function on the input_table
make_variables(estimate_read_csv(input_table))
```

## The model

The following is our draft of the emissions model, with explanations of all steps (we can format this better once we agree on the final model).


```{r ghg_emissions_function}
# Generate the GHG emissions function 
ghg_emissions<-function(x, varnames){

# Enteric fermentation emissions ($CH_4$)

# The main source of all this is Chapter 10 of the *2006 IPCC Guidelines for National Greenhouse Gas Inventories* [@dong_ipcc_2006] (Volume 4 - Agriculture, Forestry and Other Land Use). The document can be found on [the IPCC website](https://www.ipcc-nggip.iges.or.jp/public/2006gl/pdf/4_Volume4/V4_10_Ch10_Livestock.pdf).

# We start with the net energy for maintenance (NE_m; in MJ/day)
# This includes a maintenance coefficient, for which different values are recommended depending on animal type

# The following animal types were used in the example:
  
# animal type 1 - 'intact' grown-up males >=36 months
# animal type 2 - castrated grown-up males >=36 months
# animal type 3 - males 12-36 months
# animal type 4 - lactating cows
# animal type 5 - lactating cows
# animal type 6 - lactating cows
# animal type 7 - weaned young females <= 12 months
# animal type 8 - weaned young males <= 12 months
# animal type 9 - females 12-36 months
# animal type 10 - pre-weaned female calves (<12 months)
# animal type 11 - pre-weaned male calves (<12 months)
# animal type 12 - first-time pregnant cows
  
# animal types 4, 5 and 6 are all lactating cows - important to note here that the original data table appears to have worked with the actual number of months that cows were pregnant. This resulted in a weighted mean of the various maintenance coefficients. We're not sure where we could get such data. In the original dataset, types 4, 5 and 6 referred to different pregnancy/lactation states, but it doesn't seem like this scheme was rigorously followed.

# We make placeholder vectors to collect emissions data for all animal types
mm_N2O_CO2eq<-c()
mm_CH4_CO2eq<-c()
enteric_CH4_CO2eq<-c()
total_milk<-c()
  
# Now we start a long loop, where emissions are calculated for each animal type

for (animal_type in 1:12)
{
# define C and Cfi based on sex (Page 10.17, below Equation 10.6)
if(animal_type %in% c(1,3,8,11)) growth_coefficient_C<-C_intact_males # males (1.2)
if(animal_type %in% c(2)) growth_coefficient_C<-C_castrates # castrates (1.0)
if(animal_type %in% c(4,5,6,7,9,10,12)) growth_coefficient_C<-C_females # females (0.8)

if(animal_type %in% c(4,5,6)) Cfi<-maintenance_coefficient_Cfi_lact_cow # lactating cows (0.386)
if(animal_type %in% c(1)) Cfi<-maintenance_coefficient_Cfi_bulls # bulls (0.37)
if(animal_type %in% c(2,3,7,8,9,10,11,12)) Cfi<-maintenance_coefficient_Cfi_other # others (0.322)

# define mature body weight (assuming this needs to be disaggregated by sex, for Eqation 10.6)
if(animal_type %in% c(1,2,3,8,11)) mature_weight_MW<-mature_weight_MW_male
if(animal_type %in% c(4,5,6,7,9,10,12)) mature_weight_MW<-mature_weight_MW_female

# define milk yield
if(animal_type %in% c(1,2,3,7,8,9,10,11,12)) milk_yield<-0
if(animal_type %in% c(4,5,6)) milk_yield<-eval(parse(text=paste0("milk_yield_",animal_type)))

#define pregnancy coefficient (full Cp for first-time pregnant, lower for later in most cases)
if(animal_type==12) Cp<-Cp_0
if(animal_type==4) Cp<-Cp_0*Cp_rate_4
if(animal_type==5) Cp<-Cp_0*Cp_rate_5
if(animal_type==6) Cp<-Cp_0*Cp_rate_6
if(animal_type %in% c(1,2,3,7,8,9,10,11)) Cp<-0

N_animal_type<-eval(parse(text=paste0("N_animal_type_",animal_type)))

# define activity coefficient Ca (Table 10.5)
# Stall 0.00 - Animals are confined to a small area (i.e., tethered, pen, barn) with the result that they expend very little or no energy to acquire feed.
# Pasture 0.17 - Animals are confined in areas with sufficient forage requiring modest energy expense to acquire feed.
# Grazing large areas 0.36 - Animals graze in open range land or hilly terrain and expend significant energy to acquire feed.

# We don't quite understand how Ca was assigned in the original data table. There are many 0s for 'System 1' (Stall?), but also lots of values between 0 and 0.17 or 0.36. We can only imagine that these are weighted averages or reflect additional information about the feeding system, but this information doesn't seem to be given in the table. For now, we're restricting these Ca values to only those that are given as 'pure' categories in the IPCC guidelines (Table 10.5).

if(feeding_system==1) C_activity<-Ca_stall # Stall (0.0)
if(feeding_system==2) C_activity<-Ca_pasture # Stall (0.17)
if(feeding_system==3) C_activity<-Ca_large_grazing # Stall (0.36)
  
# Mean live weight (kg) of animals surely varies by animal type, so we need separate estimates for them
live_weight_LW<-eval(parse(text=paste0("live_weight_LW_",animal_type)))

# Mean weight gain of animal type (kg/day)
weight_gain_WG<-eval(parse(text=paste0("weight_gain_WG_",animal_type)))

# Calculate the Net Energy for Maintenance (NE_m) (MJ/day) (Equation 10.3)

NE_m<-Cfi*(live_weight_LW^0.75)

# Calculate the Net Energy for Activity (NE_activity) (MJ/day) (Equation 10.4)

NE_activity<-C_activity*NE_m

#Net energy for growth (NE_growth) (MJ/day) (Equation 10.6)

NE_growth<-22.02*
  ((live_weight_LW/(growth_coefficient_C*mature_weight_MW))^0.75)*
  (weight_gain_WG^1.097)

# Net energy for lactation

NE_lactation<-milk_yield*(1.47+0.40*milk_fat)

# Draft animal services are not accounted for
# NE_work <- 0.1 * NE_m * hours_per_day

#Energy need during pregnancy (Equation 10.13)
NE_pregnancy<-Cp*NE_m

# The Cp coefficient given in Equation 10.13 is 0.1, but in the sample this is only applied for animal type 12 (first-time pregnant). For all other lactating cows, this is reduced - not clear how this was done.

# Ratio of net energy available in a diet for maintenance to digestible energy consumed (Equation 10.14)
REM<-1.123-(4.092/1000*DE_perc)+(1.126/100000*DE_perc^2)-(25.4/DE_perc)

# Ratio of net energy available for growth in a diet to digestible energy consumed (Equation 10.15)
REG<-1.164-(5.160/1000*DE_perc)+(1.308/100000*DE_perc^2)-(37.4/DE_perc)

# Gross Energy (GE) MJ/day
NE_work<-0 # work animals aren't covered here, so we set this to zero
GE<-(((NE_m+NE_activity+NE_lactation+NE_work+NE_pregnancy)/REM)+(NE_growth/REG))/(DE_perc/100)

# CH4 emission factors for enteric fermentation from a livestock category (Equation 10.21)

enteric_CH4<-(GE*Y_m*365)/55.65 # kg CH4 per animal per year

# Compute the CO2-equivalent of methane emissions for enteric methane
#This converts methane emissions to their Global Warming Potential (CO2-equivalent of CH4 is 25)
enteric_CH4_CO2eq[animal_type]<-N_animal_type*enteric_CH4*25

# Manure management methane ($CH_4$) and nitrous oxide ($N_2O$)
# daily volatile solid excreted (Equation 10.24)

volsol<-(GE*
           (1-(DE_perc/100))+
           (urinary_energy*GE))*
             ((1-ash_content)/18.45) 

# The maximum methane emission from manure (Bo) depends on the animal type. In the input table, we
# treat these as constants for each animal type. The following line assigns the corresponding Bo value
##### EL CW Note #### 
##### # to the Bo variable. In the dataset we're using for Kenya, only two values for Bo are given: 0.17 for
# animal types 4-6 and 0.135 for animal types 1-3 and 7-12.

Bo<-eval(parse(text=paste0("Bo_animaltype_",animal_type)))

# decisions on manure management
# the management options we're considering here are the ones from the Excel table. The IPCC guidelines
# list more and partly different ones.

# We're deciding on manure management according to a decision tree (see figure above):

# question 1: how much of the manure is centrally collected? share_centrally
# question 2: of manure that's not centrally collected, how much is burned? share_central_burn
mms_burn<-(1-share_centrally)*share_central_burn
mms_pasture<-(1-share_centrally)*(1-share_central_burn)

# question 3: of centrally collected manure, how much is spread daily on cropland or pasture? share_spread
mms_spread<-share_centrally*share_spread
not_spread<-share_centrally*(1-share_spread)
# question 4: how much of the manure that's not spread is sold? share_sold
mms_sold<-not_spread*share_sold
not_sold<-not_spread*(1-share_sold)
# question 5: how much of the stored manure that's not sold is stored in liquid form? share_liquid
liquid<-not_sold*share_liquid
solid<-not_sold*(1-share_liquid)
# question 6: how much of the liquid manure is converted to biogas? share_biogas
mms_biogas<-liquid*share_biogas
mms_liquid_slurry<-liquid*(1-share_biogas)
# question 7: how much of the solid manure is composted? share_compost
mms_composted<-solid*share_compost
remain_solid<-solid*(1-share_compost)
# question 8: how much of the solid manure is stored in dry lots? share_drylot
mms_drylot<-remain_solid*share_drylot
mms_solidstore<-remain_solid*(1-share_drylot)

# CH4 emission factor from manure management (Equation 10.23)
mm_ch4<-(volsol*365)*
        (Bo*0.67*
           ((mms_pasture*MCFpasture)+
            (mms_spread*MCFspread)+
            (mms_drylot*MCFdrylot)+
            (mms_solidstore*MCFsolidstore)+
            (mms_composted*MCFcomposted)+
            (mms_liquid_slurry*MCFliquid)+
            (mms_biogas*MCFbiogas)+
            (mms_burn*MCFburn)+
              # CW EL Comment ####
              # the original code was lacking the 'sold' fraction - we added this for completeness
            (mms_sold*MCFsold)))

# Estimate CO2eq for manure methane
mm_CH4_CO2eq[animal_type]<-N_animal_type*mm_ch4*25

# Calculate Nitrous oxide emissions from manure and urine on pasture

# estimate N intake (kg/animal/day) (Equation 10.32)
N_intake<-(GE/18.45)*((perc_crude_protein_diet/100)/6.25)

# estimate N retention (kg/animal/day) (Equation 10.33)
N_retention<-((milk_yield*(1.9+0.4*milk_fat)/100)/6.38)+
  ((weight_gain_WG*(268-(7.03*NE_growth/weight_gain_WG)))/(1000*6.25))

# estimate N excretion (kg N/animal/yr) (Equation 10.31)
N_excretion<-N_intake*(1-N_retention)*365

# Direct nitrous oxide emissions (kg N2O/animal/yr) (Eq 10.25 from IPCC guidelines)
mm_direct_n2o<-N_excretion*((mms_pasture*mndec_pasture)+
                           (mms_spread*mndec_spread)+
                           (mms_drylot*mndec_drylot)+
                           (mms_solidstore*mndec_solidstore)+
                           (mms_composted*mndec_composted)+
                           (mms_liquid_slurry*mndec_liquid)+
                           (mms_biogas*mndec_biogas)+
                           (mms_burn*mndec_burn)+
                           (mms_sold*mndec_sold))*(44/28)

# N losses from volatilization (kg N/animal/yr) (Eq 10.26 from IPCC guidelines)
mm_vol_n<-N_excretion*((mms_pasture*mnvc_pasture)+
                           (mms_spread*mnvc_spread)+
                           (mms_drylot*mnvc_drylot)+
                           (mms_solidstore*mnvc_solidstore)+
                           (mms_composted*mnvc_composted)+
                           (mms_liquid_slurry*mnvc_liquid)+
                           (mms_biogas*mnvc_biogas)+
                           (mms_burn*mnvc_burn)+
                           (mms_sold*mnvc_sold))

# indirect N2O emissions due to volatilization of N from manure management (kg N2O/animal/year) (Equation 10.27)
mm_vol_n2o<-mm_vol_n*EF4*(44/28)

# Nitrous oxide (N2O) from leaching (kg N/animal/year) (equation 10.28)
mm_leach_n<-N_excretion*((mms_pasture*frac_leach_pasture)+
                           (mms_spread*frac_leach_spread)+
                           (mms_drylot*frac_leach_drylot)+
                           (mms_solidstore*frac_leach_solidstore)+
                           (mms_composted*frac_leach_composted)+
                           (mms_liquid_slurry*frac_leach_liquid)+
                           (mms_biogas*frac_leach_biogas)+
                           (mms_burn*frac_leach_burn)+
                           (mms_sold*frac_leach_sold))

# indirect N2O emissions due to leaching of N from manure management (kg N2O/animal/year) (Equation 10.29)
mm_leach_n2o<-mm_leach_n*EF5*(44/28)

# CW EL Comment ####
# # comment: this is probably wrong, since leached nitrogen doesn't emit (much) nitrous oxide
#mm_leach_n2o<-n_excretion*((mms_pasture*0.3)+(mms_spread*0.3)+(mms_drylot*0.3)+(mms_solidstore*0.3)+
#              (mms_composted*0.3)+(mms_liquid*0.3)+(mms_biogas*0)+(mms_burn*0))*0.0075*(44/28)

# Estimate CO2eq for manure nitrous
mm_N2O_CO2eq[animal_type]<-N_animal_type*(mm_direct_n2o+mm_vol_n2o+mm_leach_n2o)*298 # (298 is the CO2-equivalent of N2O)

total_milk[animal_type]<-N_animal_type*milk_yield*365

}

# Emissions from feed production and transport. 
# CW EL Comment ####
  # comment: the numbers in the table seem spuriously precise.
  ####
  
feed_CO2<-feed_prod_CO2*feed_trans_CO2

# Total emissions
on_farm<-enteric_CH4_CO2eq+mm_CH4_CO2eq+mm_N2O_CO2eq+feed_CO2

return(list(enteric_CH4=enteric_CH4,
            milk_yield=sum(total_milk),
            enteric_CH4_CO2eq=sum(enteric_CH4_CO2eq),
            mm_CH4_CO2eq=sum(mm_CH4_CO2eq),
            mm_N2O_CO2eq=sum(mm_N2O_CO2eq),
            feed_CO2=feed_CO2,
            on_farm=sum(on_farm)))
}
```

## Running the model

We apply the `decisionSupport` tools for running the Monte Carlo simulation [@R-decisionSupport]. See the vignette guides on *applying the mcSimulation function* [@fernandez_applying_2021] and *simulating the cost effectiveness of controlled burning* [@whitney_simulating_2017] for examples.

```{r monte_carlo_simulation}
GHG_simulation <- mcSimulation(
  estimate = estimate_read_csv("data/livestock_ghg_input_table.csv"),
  model_function = ghg_emissions,
  numberOfModelRuns = 1e2, #100 for now
  functionSyntax = "plainNames"
)
```

Here we plot the distributions of the various outputs from the model. 

```{r plot_distributions, fig.width=10, fig.height=10}
# enteric_CH4=enteric_CH4,
enteric_CH4_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "enteric_CH4",
                   method = "boxplot_density",
                   old_names = "enteric_CH4",
                   new_names = "Total Methane Emissions from Livestock by Enteric Fermentation") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# milk_yield=sum(total_milk),
milk_yield_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "milk_yield",
                   method = "boxplot_density",
                   old_names = "milk_yield",
                   new_names = "Total Milk Yield") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# enteric_CH4_CO2eq=sum(enteric_CH4_CO2eq),
enteric_CH4_CO2eq_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "enteric_CH4_CO2eq",
                   method = "boxplot_density",
                   old_names = "enteric_CH4_CO2eq",
                   new_names = "Carbon Dioxide Equivalent Enteric Methane Emissions from Livestock") + 
  theme(axis.title.x=element_blank())

# mm_CH4_CO2eq=sum(mm_CH4_CO2eq),
mm_CH4_CO2eq_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "mm_CH4_CO2eq",
                   method = "boxplot_density",
                   old_names = "mm_CH4_CO2eq",
                   new_names = "Carbon Dioxide Equivalent Methane Emissions from Livestock Manure") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# mm_N2O_CO2eq=sum(mm_N2O_CO2eq),
mm_N2O_CO2eq_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "mm_N2O_CO2eq",
                   method = "boxplot_density",
                   old_names = "mm_N2O_CO2eq",
                   new_names = "Carbon Dioxide Equivalent Nitrous Oxide Emissions from Livestock Manure") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# feed_CO2=feed_CO2,
feed_CO2_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "feed_CO2",
                   method = "boxplot_density",
                   old_names = "feed_CO2",
                   new_names = "Carbon Dioxide Emissions from Livestock Feed Production and Transport") + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank())

# on_farm=sum(on_farm)
on_farm_dist_plot <- plot_distributions(mcSimulation_object = GHG_simulation,
                   vars = "on_farm",
                   method = "boxplot_density",
                   old_names = "on_farm",
                   new_names = "Total Carbon Dioxide Equivalent Emissions from Livestock") + 
  theme(axis.title.y=element_blank())

library(patchwork)
# remove the axis marks from the two lefthand-most plots and the x-axis title from the left and right plots

# plot with patchwork
layout <- "
           AAABBB
           CCCDDD
           EEEFFF
           GGGGGG
          "

enteric_CH4_dist_plot + milk_yield_dist_plot + 
  enteric_CH4_CO2eq_dist_plot + mm_CH4_CO2eq_dist_plot + 
  mm_N2O_CO2eq_dist_plot + feed_CO2_dist_plot + 
  on_farm_dist_plot + 
plot_layout(guides = "collect", design = layout) 
```

## Model sensitivity

#### Perform a Partial Least Squares Regression (PLSR) of Monte Carlo simulation results

Below we apply a post-hoc analysis to the `mcSimulation()` outputs with the `plsr.mcSimulation()` function in the `decisoonSupport` package. We use the function to determine the Variable Importance in the Projection (VIP) score and coefficients of a Projection to Latent Structures (PLS) regression model. This function uses the outputs of the `mcSimulation()` selecting all the input variables from the `GHG_simulation` decision analysis function in the parameter `object` and then runs a PLS regression with an outcome variable defined in the parameter `resultName`. We use the code `names(GHG_simulation$y)[7]` to select the outcome variable `r names(GHG_simulation$y)[7]`, which is an element of the list `y` in our `GHG_simulation` outputs. 

```{r}
pls_result <- plsr.mcSimulation(object = GHG_simulation,
                  resultName = names(GHG_simulation$y)[7], ncomp = 1)
```

We run the `plot_pls()` on the results from `plsr.mcSimulation()` with a number of standard settings. The length of the bars is equal to VIP with a vertical line at '1' on the x-axis indicating a standard cut-off for VIP used for variable selection [@Whitney2017]. The overall plot only shows those variables with a VIP > 0.8, which is the common threshold for variable selection [@Lanzanova2019, @Luedeling2016]. The colors of the bars represent the positive or negative coefficient of the given input variable with the output variable.

Here we import the input table again (the same table we used for the Monte Carlo model) to replace the labels for the variables on the y-axis. The input table includes a 'label' and 'variable' column. The standard labels (from the 'variable' column) are usually computer readable and not very nice for a plot. The `plot_pls()` function uses the text in the 'label' column as replacement for the default text in the 'variable' column.  

```{r}
input_table <- read.csv("data/livestock_ghg_input_table.csv")

plot_pls(pls_result, input_table = input_table, threshold = 0)
```


# Uncertainty

We apply a collection of functions for use in assessing uncertainty in the relationship between GHG emissions and milk yields in livestock production. We use functions from the `uncertainty` package. Install the package using `devtools::install_github("CWWhitney/uncertainty")`. 

We apply the uncertainty functions on the `milk_yield` and `on_farm` variables. These come from the model results (`r nrow(GHG_simulation$y)`) of the `GHG_simulation` model results to the `in_var` (x) and an outcome variable `out_var` (y). in the model we defined `on_farm` as the sum of Carbon Dioxide Equivalent Enteric Methane Emissions from Livestock (`enteric_CH4_CO2eq`), Carbon Dioxide Equivalent Methane Emissions from Livestock Manure (`mm_CH4_CO2eq`), Carbon Dioxide Equivalent Nitrous Oxide Emissions from Livestock Manure (`mm_N2O_CO2eq`) and Carbon Dioxide Emissions from Livestock Feed Production and Transport (`feed_CO2`).

```{r name_in_out_vars}
in_var  <- GHG_simulation$y$milk_yield
out_var <- GHG_simulation$y$on_farm
```

## Milk_yield (x-axis) effect on on farm GHG emissions (y-axis)

Here we use the `varscatter()` function to create a scatter plot of milk yields `in_var` (x) and GHG emissions `out_var` (y) with associated and estimated densities with loess smooth linear fits density curves. Plot made with the scatter.hist() function in the `plyr()` package [@R-plyr] in R [@R-base]. The result is a scatter plot with associated and estimated densities (using a loess smooth) given by the red dot (mean) and red ellipses (1 and 2 sigma from mean). The red line going across the plot shows the linear fit. Histograms are shown with smooth lines (loess smooth linear fits) density curves. The numeric value in the upper right gives the Spearman correlation coefficient between the influencing variable and the outcome variable.

```{r uncertainty_package}
uncertainty::varscatter(in_var = in_var,
                        out_var = out_var)
```

To verify the finding we use the `varkernel()` function for another type of graphical representation of the same relationship. We use the `varkernel()` function to perform a two-dimensional kernel density estimation for the expected value of GHG emissions and milk yield. The core of the process involves kernel density estimation. This is a nonparametric technique for estimating probability density functions (similar to histogram density estimation but with more dimensions). We apply this with the `kde2d()` function in the `MASS()` package [@R-MASS]. The function produces a matrix of the estimated density (z) of the expected value of the GHG emissions and milk yield. It looks slightly different than the scatter plot estimates above because the density function restricts the shape of the kernel to a normal distribution (a bivariate normal kernel).

```{r varkernel}
uncertainty::varkernel(in_var = in_var, out_var = out_var)
```

The result of the `varkernel()` function shows a density surface plot of GHG emissions `in_var` (x) and milk yield `out_var` (y). In these `varkernel()` the density (z) over the entire plot integrates to one, and therefore represents the relative probability of an observation (the GHG emissions `out_var` along the y-axis) given a specific value for milk yield `in_var` (along the x-axis). The legend shows the value for the estimated density (z). The plot is made with the `filled.contour()` function of the `graphics()` package [@R-base]. 

## Influencing variable intervals

Here we use the `varviolin()` function to determine different milk yield variable intervals by calculating the optimal interval width. This is done using the interquartile range `IQR()` function in the `stats()` package. We follow the Freedman-Diaconis rule to select the width of the bins.

$Os = 2 * IQRs / (obs_IQRs)^{(1/3)}$

Where $Os$ is The optimal interval width for our sample, $IQRs$ is the interquartile range for our sample and $obs_IQRs$ is the total number of observations for the interquartile range for our sample.

```{r varviolin, fig.width=17, fig.height=7}
uncertainty::varviolin(in_var = in_var, out_var = out_var, legend.position = "left")
```

The result of the `varviolin()` function shows violin plots of milk yield `in_var` values (x) and our outcome variable GHG emissions `out_var` (y) values. The plot was made with `ggplot2()` [@R-ggplot2].

## Probability of outcome variable for a given range of the input variable

`varkernelslicerange()` shows the influencing variable `in_var` value intervals, optimized interquartile ranges shown in `varviolin()` can be used to select a range to slice from the density kernel `varkernel()` as was done for a single variable value in `varkernelslice()`. Here we set the maximum expected value for `in_var` to `r round(max(in_var), digits = 0)` and the minimum expected value to `r round(min(in_var), digits = 0)`.

```{r varkernelslicerange}
uncertainty::varkernelslicerange(in_var = in_var, out_var = out_var, 
                                 min_in_var = round(min(in_var)),
                                 max_in_var = round(max(in_var)))
```

`varkernelslicerange()` plots the probabilities (shown along the y-axis) for the expected value of the outcome variable `out_var` (shown along the x-axis). As with `varkernelslice()` the probability values shown are relative, not absolute measures. They are the result of cuts through the density kernel `varkernel()`, which integrates to 1. 

This document was generated using R Markdown [@R-rmarkdown].

# References