---
title: "GHG model"
author: "Cory and Eike"
date: "6/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Retracing the equations of the GHG emissions model

We're looking at the equation put together by Joshua Wafula to check if this can easily be used by decisionSupport, and to possibly optimize the model.

Here's the original model

```{r}

library(decisionSupport)
#CW Note ####
# remove all the 'C:/Users/jwafula/Dropbox/UNIQUE_CCAFS/analysis/data/' business
# This project will look in relative file paths (i.e. same or lower folders)
input_table <- "livestock_ghg_input_table.csv"
results_folder <- "MC results"

# Generate a function for testing the model function 'line by line' 
# by taking a single random sample of the provided estimates
make_variables <- function(est,n=1){ x <- random(rho=est, n=n)
for(i in colnames(x)) assign(i, as.numeric(x[1,i]),envir=.GlobalEnv)}
# run the function on the input_table
make_variables(estimate_read_csv(input_table))

# Generate the GHG emissions function 
ghg_emissions<-function(x, varnames){

# Enteric fermentation emissions ($CH_4$)
  #CW Note ####
  #in these code sections I am missing the overview. 
  # it is not immediately clear what this is meant to do... 
  # from a specific publication? 
  
# This equation is documented in "Good Practice Guidance and Uncertainty Management in National Greenhouse Gas Inventories" p. 313
# We note that these equations are full of formatting mistakes that don't exactly instill confidence that all the numbers are correct.  
  
  
# We start with the net energy for maintenance (NE_m; in MJ/day)
# This includes a maintenance coefficient, for which different values are recommended depending on animal type
NE_m<-maintenaince_coefficient_Cfi*(live_weight_LW^0.75)

# The energy use for specific activities is calculated by multiplying NE_m by an activity coefficient (C_activity).

NE_activity<-C_activity*NE_m

#Net energy for growth (NE_growth; MJ/day):

NE_growth<-4.18*((0.0635*478/(C*FSBW))^0.75*(0.96*SWG)^1.097)

# here, C is an animal type coefficient
# FSBW: final shrunk body weight in kg - this is the actual final body weight multiplied by 0.96 (to subtract the last meal)
# SWG is the "Shrunk Weight Gain" in kg per day - we're not sure what exactly this means.

#This used to be the following equation, which we didn't find a source for:
#NE_growth<-22.02*(((live_weight_LW/(growth_coefficient_C*mature_weight_MW))^0.75)*(weight_gain_WG^1.097))

#The code doesn't include net energy mobilization by animals that lose weight (p. 314)

#Net energy for lactation

NE_lactation<-milk_yield*(1.47+0.40*milk_fat)

#variables:
#milk_yield (kg milk per day)
#milk_fat (percent)

#Draft animal services are not accounted for

#Energy need during pregnancy 
NE_pregnancy<-0.10*NE_m

#in Joshua's equation the 0.10 was a variable called pregnancy_coefficient_Cp with a value around 0.03. We're not sure where this came from.

#We've now covered all equations up to eq 10 (p. 315)

#Equation 11 contains calculation of the metabolizable energy, but that doesn't seem to be used anywhere

#Now we calculate the ratio between net energy consumed and the digestible energy consumed, for maintenance (NE_DE) and growth (NEg_DE) (eqs. 12 and 13)

NE_DE<-(1.123-(4.092*(10^-3)*dig_energy)+(1.126*(10^-5)*(dig_energy^2))-(25.4/dig_energy))

NEg_DE<-(1.164-(5.160*(10^-3)*dig_energy)+(1.308*(10^-5)*(dig_energy^2))-(37.4/dig_energy))

#the following equation usually contains the energy mobilized by animals losing weight. This wasn't calculated, so we set this to 0
NE_mobilized<-0
#same for extra energy spent by working animals
NE_w<-0

gross_energy_intake<-(((NE_m+NE_mobilized+NE_activity+NE_lactation+NE_w+NE_pregnancy)/NE_DE)+(NE_growth/NEg_DE))/(dig_energy/100)

enteric_CH4<-(gross_energy_intake*Y_m*365)/55.65 

#Y_m here is the methane conversion rate - Joshua used the IPCC default value of 6.5%. Full story is on page 302 (a bit more complicated, with differentiation by animal type)

# Compute the CO2 equation for enteric methane
#This equation originally included multiplication by 365 - this seems to have been erroneous (already done in the previous line)
#This converts methane emissions to their Global Warming Potential (CO2-equivalent of CH4 is 25)
enteric_CO2=enteric_CH4*25

# Manure management methane ($CH_4$) and nitrous oxide ($N_2O$)
# daily volatile solid excreted (page 10.42 of 2006 IPCC Guidelines for National Greenhouse Gas Inventories)

volsol<-(gross_energy_intake*
           (1-(dig_energy/100))+
           (urinary_energy*gross_energy_intake))*
             ((1-ash_content)/18.45) 



# The maximum methane emission from manure (Bo) depends on the animal type. In the input table, we
# treat these as constants for each animal type. The following line assigns the corresponding Bo value
# to the Bo variable. In the dataset we're using for Kenya, only two values for Bo are given: 0.17 for
# animal types 4-6 and 0.135 for animal types 1-3 and 7-12.

Bo<-eval(parse(text=paste0("Bo_animaltype_",animal_type)))

# the following is page 10.41 of the 2006 IPCC Guidelines for National Greenhouse Gas Inventories
mm_ch4<-(volsol*365)*
        (Bo*0.67*
           ((mms_pasture*MCFpasture)+
            (mms_spread*MCFspread)+
            (mms_drylot*MCFdrylot)+
            (mms_solidstore*MCFsolidstore)+
            (mms_composted*MCFcomposted)+
            (mms_liquid*MCFliquid)+
            (mms_biogas*MCFbiogas)+
            (mms_burn*MCFburn)+
              # the original code was lacking the 'sold' fraction - we added this for completeness
            (mms_sold*MCFsold)))

# Estimate CO2eq for manure methane
### this one also contained a multiplication by 365 that seemed erroneous
mm_CO2<-mm_ch4*25


##### WE STOPPED HERE


# Calculate Nitrous oxide emissions from manure and urine on pasture
n_intake<-(gross_energy_intake/18.45)*((pregnancy_coefficient_Cp/100)/6.25)
n_retension<-((milk_yield*(3.3/100))/6.38)
n_excretion<-n_intake*(1-n_retension)*365
mm_direct_n2o<-n_excretion*((mms_pasture*0.02)+(mms_spread*0.005)+(mms_drylot*0.02)+(mms_solidstore*0.005)+
               (mms_composted*0.006)+(mms_liquid*0.005)+(mms_biogas*0)+(mms_burn*0))*0.01*(44/28)

# Nitrous oxide (N2O) from volatization 
mm_vol_n2o<-(n_excretion*((mms_pasture*0.02)+(mms_spread*0.07)+(mms_drylot*0.2)+(mms_solidstore*0.3)+
            (mms_composted*0.3)+(mms_liquid*0.4)+(mms_biogas*0)+(mms_burn*0))*0.01*(44/28))

# Nitrous oxide (N2O) from leaching 
mm_leach_n2o<-n_excretion*((mms_pasture*0.3)+(mms_spread*0.3)+(mms_drylot*0.3)+(mms_solidstore*0.3)+
              (mms_composted*0.3)+(mms_liquid*0.3)+(mms_biogas*0)+(mms_burn*0))*0.0075*(44/28)

# Estimate CO2eq for manure nitrous
mm_CO2_N2Od<-mm_direct_n2o*298*365
mm_CO2_N2Ovol<-mm_vol_n2o*298*365
mm_CO2_N2Oleach<-mm_leach_n2o*298*365
mm_CO2_N2O<-mm_CO2_N2Od+mm_CO2_N2Ovol+mm_CO2_N2Oleach

# Emissions from feed production and transport. 
feed_CO2<-feed_prod_CO2*feed_trans_CO2

# Total emissions
on_farm<-enteric_CH4+enteric_CO2+mm_CO2+mm_CO2_N2O+feed_CO2

#CW Note ####
# Not clear what this part does (through to the ggplot)

# Relationship between greenhouse gas intensity and milk yields. 
# Fat adjusts
ann_adj <-kg_FPCM_year*365 
df <- data.frame(
  GHGi = on_farm/ann_adj, 
  FPCM = ann_adj)

# plot

#library(ggplot2)
#ggplot(df, aes(x = FPCM, y = GHGi)) +geom_point() + ylim(0,50) 

return(list(enteric_CH4=enteric_CH4,
            #CW NOTE ####
            #working backwards from 'enteric_CO2' I see that 
            # this is the product of something twice multiplied by 365
            enteric_CO2=enteric_CO2,
            mm_CO2=mm_CO2,
            mm_CO2_N2O=mm_CO2_N2O,
            feed_CO2=feed_CO2,
            on_farm=on_farm))
}

```



This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
